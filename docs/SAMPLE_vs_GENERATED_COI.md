# Sample COI vs Generated COI

## Overview
The system handles **two different types** of Certificates of Insurance (COIs):

### Sample COI
**Purpose:** Project-specific requirement template showing coverage structure for this job

**Content:**
- ✅ ACORD 25 form (blank fields for broker/policy details)
- ✅ **Job location** (project address)
- ✅ **Certificate holder** (General Contractor name)
- ✅ **Additional insureds** (entities required for this project)
- ✅ **Required coverage types** (GL, WC, Umbrella, Auto as applicable)
- ✅ **Required coverage limits** (amounts from program requirements for this specific trade)
- ❌ **No broker/producer details** (left blank as "PRODUCER")
- ❌ **No policy carrier names**
- ❌ **No policy numbers**
- ❌ **No effective/expiration dates**
- ❌ **No named insured details** (blank "INSURED" box)

**When sent:** In broker notification emails when subcontractor is added to project (including repeats)

**Who generates:** Backend email service (`generateSampleCOIPDF`) using project + program data

**Data used:**
- `project_name` - "Project Name"
- `projectAddress` - "123 Main St, Brooklyn, NY 11201"
- `gc_name` - Certificate holder name
- `trade` - Trade type for this job (to determine coverage requirements)
- `additional_insureds` - List of entities that must be covered
- Program requirements - Coverage limits for this specific trade

---

### Generated COI
**Purpose:** Actual certificate uploaded by broker/extracted from policies

**Content:**
- ✅ ACORD 25 form (populated with actual data)
- ✅ **Broker/producer information** (name, contact, company)
- ✅ **Policy carrier details** (insurance company name)
- ✅ **Policy numbers** (GL, WC, Umbrella, Auto)
- ✅ **Effective and expiration dates** (policy period)
- ✅ **Named insured** (contractor/subcontractor)
- ✅ **Coverage amounts** (actual policy limits)
- ✅ **Certificate holder** (GC/project owner)
- ✅ **Additional insureds** (all entities that must be covered)

**When created:** After broker uploads actual COI PDF or policies

**How populated:**
1. **Broker uploads ACORD 25** → System extracts producer/insured/carrier/numbers/dates via OCR/PDF parsing
2. **System generates from policies** → GL, WC, Umbrella, Auto PDFs are analyzed for coverage details

---

## Key Differences

| Aspect | Sample COI | Generated COI |
|--------|-----------|---------------|
| **Purpose** | Template/requirement reference | Actual proof of coverage |
| **Broker Info** | Blank template | Populated from upload |
| **Policy Numbers** | None | Extracted from PDF |
| **Dates** | None | Extracted from PDF |
| **Carrier Name** | None | Extracted from PDF |
| **Named Insured** | None | Extracted from PDF |
| **Signature** | Not required | Required (broker signature) |
| **PDF Type** | Generated by system | Uploaded by broker |

---

## Technical Implementation

### Sample COI Generation
```javascript
const generateSampleCOIPDF = async (data = {}) => {
  // data contains ONLY:
  // - gc_name (certificate holder)
  // - additional_insured_entities (from project)
  // - program requirements (coverage limits)
  
  // Generates ACORD 25 with:
  // - Blank producer box (placeholder text)
  // - Blank insured box (placeholder text)
  // - Required coverage types & limits (from program)
  // - NO policy numbers, dates, or carrier info
}
```

### Generated COI Creation
```javascript
// When broker uploads ACORD COI PDF:
// 1. Extract producer/insured/carrier/policy#/dates via OCR
// 2. Store in GeneratedCOI record
// 3. Admin reviews and approves
// 4. System confirms all required insureds are listed

const generatedCOI = {
  broker_email,        // ← From producer box
  broker_name,         // ← From producer box
  insured_name,        // ← From insured box
  gl_policy_number,    // ← From GL section
  gl_effective_date,   // ← From GL section
  gl_expiration_date,  // ← From GL section
  carrier_gl,          // ← From GL section
  // ... other policies ...
  additional_insureds  // ← Must match project requirements
}
```

---

## NYC Property Lookup Integration

When a GC enters a project address:

1. **Geoclient** resolves address → BBL (block/lot), BIN, borough
2. **ACRIS Deeds (Socrata)** → Owner entity (grantee from latest deed)
3. **DOB Job Filings (Socrata)** → Structure type & unit count from **latest GC permit**
   - Uses `job_type` field for structure type
   - Uses `dwelling_units` field for unit count

**Sample output:**
```json
{
  "address": "123 Main St, Brooklyn, NY 11201",
  "city": "Brooklyn",
  "state": "NY",
  "zip_code": "11201",
  "block_number": "00123",
  "lot_number": "0045",
  "bin": "1012345",
  "height_stories": 8,
  "project_type": "New Building Construction",
  "unit_count": 45,
  "owner_entity": "123 Main Street LLC",
  "additional_insured_entities": []
}
```

The system then uses these values (owner_entity, unit_count, etc.) to populate the project record and Sample COI.

---

## Data Flow

```
PROJECT SETUP
    ↓
[GC enters address]
    ↓
NYC Geoclient + DOBNow lookup
    ↓
Auto-populate: owner_entity, unit_count, structure_type
    ↓
[GC adds subcontractor to project]
    ↓
System generates Sample COI
    ↓
Broker gets email with Sample COI (template only)
    ↓
[Broker uploads actual COI PDF + policies]
    ↓
System extracts broker info, policy #s, dates
    ↓
Creates GeneratedCOI record with all policy details
    ↓
[Admin reviews and approves]
    ↓
Work can proceed
```

---

## Notes

- **Sample COI is not a legal document** — it's a requirement reference
- **Generated COI becomes the legal binding certificate** — includes all actual policy info
- **Broker uploads are required** — system cannot generate valid COIs without actual policy documents
- **OCR extraction may need manual review** — complex policy documents may require admin corrections
